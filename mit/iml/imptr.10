TITLE IMLAC PAPER TAPE READER
;COPIES 8BIT PAPER TAPE TO DSK FILE SPEC'ED BY JCL,
;DEFAULTING TO IMTAPE >.

A=1 ? B=2 ? C=3 ? CNT=4 ? WRD=5 ? ADR=6 ? FT=7  ? P=17
PTRI=10 ? DSKO=11
MAXADR=37777
.MLLIT==1

DEFINE BARF MSG
	.VALUE [ASCIZ \:AT DDT - !MSG!î\]
TERMIN

GO:	MOVEI P,PDL
	.SUSET [.SSNAM,,[SIXBIT \IMLAC\]]
	.OPEN PTRI,[14,,'PTR]
	 BARF PTR OPEN FAILED
	.OPEN DSKO,[7,,'DSK ? 'IMTAPE ? SIXBIT \>\]
	 BARF DSK OPEN FAILED
	SETOM FT
LP:	.IOT PTRI,CNT
	JUMPE CNT,LP
	PUSHJ P,GET2
	MOVE ADR,A
	CAIN ADR,177777
	JRST WINDUP
	ADDI ADR,1000
	JUMPE FT,LP1
	SETZM FT
	MOVEM ADR,LADR
LP1:	PUSHJ P,GET2
	MOVE WRD,A
	MOVEM WRD,(ADR)
	AOJ ADR,
	SOJG CNT,LP1
	PUSHJ P,GET2		;GOBBLE CHECKSUM WORD
	MOVEM ADR,ADDR		;SAVE LAST ADDRESS
	JRST LP
GET2:	.IOT PTRI,A
	LSH A,10
	.IOT PTRI,B
	IOR A,B
	POPJ P,

WINDUP:	PUSHJ P,GET2	; GET AUTO-START ADDRESS
	MOVEI B,113714	; I JMP .+1
	MOVEM B,1000+MAXADR-64
	MOVEM A,1000+MAXADR-63	; special auto-start address
	.CLOSE PTRI,
	MOVE ADR,ADDR
	SUB ADR,LADR
	MOVNS ADR
	HRLZS ADR
	IOR ADR,LADR
	.IOT DSKO,ADR
	.CLOSE DSKO,
	BARF ALL DONE
	JRST GO

PDL:	BLOCK 10
ADDR:	0
LADR:	0
PATCH:	BLOCK 20
	LOC 1000
	BLOCK 100000
END GO
